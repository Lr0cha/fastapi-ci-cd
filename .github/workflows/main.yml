name: CI/CD Pipeline - Build, Push FastAPI Application

on:
  push:
    branches:
      - main 
    paths-ignore:
      - '**.md'

env:
  DOCKER_REPO: ${{ secrets.DOCKER_HUB_USERNAME }}/fastapi-app

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:

        - name: Checkout Repository
          uses: actions/checkout@v5

        - name: Log in to Docker Hub
          uses: docker/login-action@v3

          with:
            username: ${{ secrets.DOCKER_HUB_USERNAME }}
            password: ${{ secrets.DOCKER_HUB_TOKEN }}
            
        - name: Build and Push Docker Image
          uses: docker/build-push-action@v6
          with:
            context: .
            file: Dockerfile
            push: true
            tags: |
              ${{env.DOCKER_REPO}}:v${{github.run_number}}
              ${{ secrets.DOCKER_HUB_USERNAME }}/fastapi-app:latest